databases:
  - name: kib-postgres
    plan: free
    databaseName: kib
    postgresMajorVersion: 16
    ipAllowList: []

services:
  - type: web
    name: kib-api
    runtime: python
    plan: starter
    buildCommand: PIP_DEFAULT_TIMEOUT=120 pip install --retries 10 -r services/api/requirements.txt
    startCommand: uvicorn services.api.app.main:app --host 0.0.0.0 --port $PORT
    preDeployCommand: python scripts/init_db.py
    healthCheckPath: /health
    envVars:
      - key: KIB_DATABASE_URL
        fromDatabase:
          name: kib-postgres
          property: connectionString
      - key: KIB_RAG_SERVICE_URL
        fromService:
          name: kib-rag
          type: web
          envVarKey: RENDER_EXTERNAL_URL
      - key: KIB_REQUEST_TIMEOUT_SECONDS
        value: "30"
      - key: KIB_MOCK_OIDC
        value: "false"
      - key: KIB_OIDC_ISSUER
        sync: false
      - key: KIB_OIDC_AUDIENCE
        sync: false
      - key: KIB_OIDC_JWKS_URL
        sync: false
      - key: KIB_OIDC_ROLES_CLAIM
        value: "roles"
      - key: KIB_OIDC_USER_CLAIM
        value: "preferred_username"
      - key: KIB_OIDC_NAME_CLAIM
        value: "name"
      - key: KIB_OIDC_DEPARTMENT_CLAIM
        value: "department"
      - key: KIB_AUDIT_READ_ROLES
        value: "compliance,audit_admin"

  - type: web
    name: kib-rag
    runtime: python
    plan: starter
    buildCommand: PIP_DEFAULT_TIMEOUT=120 pip install --retries 10 -r services/rag/requirements.txt
    startCommand: uvicorn services.rag.app.main:app --host 0.0.0.0 --port $PORT
    healthCheckPath: /health
    envVars:
      - key: KIB_DATABASE_URL
        fromDatabase:
          name: kib-postgres
          property: connectionString
      - key: KIB_EMBEDDING_MODEL
        value: "intfloat/multilingual-e5-base"
      - key: KIB_LLM_PROVIDER
        value: "openai_compatible"
      - key: KIB_LLM_BASE_URL
        value: "https://api.fireworks.ai/inference/v1"
      - key: KIB_LLM_MODEL
        value: "fireworks/kimi-k2p5"
      - key: KIB_LLM_API_KEY
        sync: false
      - key: KIB_LLM_TIMEOUT_SECONDS
        value: "30"

  - type: web
    name: kib-ingestion
    runtime: python
    plan: starter
    buildCommand: PIP_DEFAULT_TIMEOUT=120 pip install --retries 10 -r services/ingestion/requirements.txt
    startCommand: uvicorn services.ingestion.app.main:app --host 0.0.0.0 --port $PORT
    healthCheckPath: /health
    disk:
      name: uploads
      mountPath: /data/uploads
      sizeGB: 1
    envVars:
      - key: KIB_DATABASE_URL
        fromDatabase:
          name: kib-postgres
          property: connectionString
      - key: KIB_UPLOADS_DIR
        value: "/data/uploads"
      - key: KIB_CHUNK_SIZE
        value: "800"
      - key: KIB_CHUNK_OVERLAP
        value: "100"
      - key: KIB_EMBEDDING_MODEL
        value: "intfloat/multilingual-e5-base"
